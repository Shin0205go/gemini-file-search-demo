<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ±ç”¨NotebookLM</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      height: 90vh;
      display: grid;
      grid-template-columns: 300px 1fr;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      background: #f8f9fa;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .project-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .project-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .project-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .project-item.active {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .project-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .project-meta {
      font-size: 11px;
      opacity: 0.6;
    }

    .add-project-btn {
      margin: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .add-project-btn:hover {
      transform: translateY(-2px);
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .main-area {
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 13px;
      opacity: 0.9;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      background: #f8f9fa;
    }

    .message {
      margin-bottom: 25px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      text-align: right;
    }

    .message-content {
      display: inline-block;
      max-width: 70%;
      padding: 15px 20px;
      border-radius: 18px;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-content {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
      text-align: left;
    }

    .message-text {
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .citations {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }

    .citations-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 8px;
      opacity: 0.7;
    }

    .citation {
      background: rgba(0,0,0,0.05);
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .citation-file {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .citation-snippet {
      opacity: 0.8;
      font-style: italic;
    }

    .timestamp {
      font-size: 11px;
      opacity: 0.5;
      margin-top: 5px;
    }

    .input-container {
      padding: 20px 30px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    .input-box {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s;
    }

    .input-box:focus {
      border-color: #667eea;
    }

    .input-box:disabled {
      background: #f0f0f0;
      cursor: not-allowed;
    }

    .send-button {
      padding: 15px 35px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .send-button:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .welcome-message {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .welcome-message h2 {
      margin-bottom: 15px;
      color: #333;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-header h3 {
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .delete-btn {
      float: right;
      padding: 4px 8px;
      font-size: 11px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>ğŸ“š NotebookLM</h2>
        <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</p>
      </div>
      <div class="project-list" id="project-list">
        <div class="welcome-message">
          <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
      </div>
      <button class="add-project-btn" onclick="showAddProjectModal()">
        â• æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
      </button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div class="main-area">
      <div class="header">
        <h1 id="current-project-name">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</h1>
        <p id="current-project-desc">ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      </div>

      <div class="chat-container" id="chat-container">
        <div class="welcome-message">
          <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
          <p>å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰è³ªå•ã—ãŸã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„</p>
        </div>
      </div>

      <div class="input-container">
        <input
          type="text"
          class="input-box"
          id="question-input"
          placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          disabled
          onkeypress="handleKeyPress(event)"
        />
        <button class="send-button" id="send-button" disabled onclick="sendQuestion()">
          é€ä¿¡
        </button>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="add-project-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ </h3>
      </div>
      <div class="form-group">
        <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå *</label>
        <input type="text" id="project-name" placeholder="ä¾‹: My Awesome Project" />
      </div>
      <div class="form-group">
        <label>èª¬æ˜</label>
        <textarea id="project-description" rows="3" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜ï¼ˆä»»æ„ï¼‰"></textarea>
      </div>
      <div class="form-group">
        <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ *</label>
        <input type="text" id="project-path" placeholder="/path/to/your/project" />
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeAddProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="add-project-submit-btn" onclick="addProject()">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <script>
    let currentProjectId = null;
    let isLoading = false;

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadProjects() {
      try {
        const response = await fetch('/api/projects');
        const data = await response.json();
        renderProjects(data.projects);
      } catch (error) {
        console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
    function renderProjects(projects) {
      const container = document.getElementById('project-list');

      if (projects.length === 0) {
        container.innerHTML = '<div class="welcome-message"><p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“<br>ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p></div>';
        return;
      }

      container.innerHTML = projects.map(project => `
        <div class="project-item ${project.id === currentProjectId ? 'active' : ''}" onclick="selectProject('${project.id}')">
          <div class="project-name">${project.name}</div>
          <div class="project-meta">
            ${project.fileCount || 0} files
            <button class="delete-btn" onclick="event.stopPropagation(); deleteProject('${project.id}')">å‰Šé™¤</button>
          </div>
        </div>
      `).join('');
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
    function selectProject(projectId) {
      currentProjectId = projectId;

      fetch('/api/projects')
        .then(res => res.json())
        .then(data => {
          const project = data.projects.find(p => p.id === projectId);
          if (project) {
            document.getElementById('current-project-name').textContent = project.name;
            document.getElementById('current-project-desc').textContent = project.description || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜';
            document.getElementById('question-input').disabled = false;
            document.getElementById('send-button').disabled = false;

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div class="welcome-message"><h2>è³ªå•ã—ã¦ãã ã•ã„</h2><p>ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•ã§ãã¾ã™</p></div>';

            renderProjects(data.projects);
          }
        });
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
    async function deleteProject(projectId) {
      if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã‚¹ãƒˆã‚¢ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      try {
        const response = await fetch(`/api/projects/${projectId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          if (currentProjectId === projectId) {
            currentProjectId = null;
            document.getElementById('current-project-name').textContent = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„';
            document.getElementById('current-project-desc').textContent = '';
            document.getElementById('question-input').disabled = true;
            document.getElementById('send-button').disabled = true;
          }
          loadProjects();
        } else {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // è³ªå•ã‚’é€ä¿¡
    async function sendQuestion() {
      if (!currentProjectId) {
        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const input = document.getElementById('question-input');
      const question = input.value.trim();

      if (!question || isLoading) return;

      addMessage('user', question);
      input.value = '';

      isLoading = true;
      const button = document.getElementById('send-button');
      button.disabled = true;
      button.innerHTML = '<span class="loading"></span>';

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, projectId: currentProjectId })
        });

        const data = await response.json();

        if (response.ok) {
          addMessage('ai', data.answer, data.citations, data.timestamp);
        } else {
          addMessage('ai', `ã‚¨ãƒ©ãƒ¼: ${data.error}`, [], new Date().toISOString());
        }
      } catch (error) {
        addMessage('ai', 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', [], new Date().toISOString());
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        isLoading = false;
        button.disabled = false;
        button.innerHTML = 'é€ä¿¡';
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    function addMessage(type, text, citations = [], timestamp = null) {
      const container = document.getElementById('chat-container');
      const welcome = container.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      let citationsHTML = '';
      if (citations && citations.length > 0) {
        citationsHTML = `
          <div class="citations">
            <div class="citations-title">ğŸ“ å¼•ç”¨å…ƒ:</div>
            ${citations.map(c => `
              <div class="citation">
                <div class="citation-file">ğŸ“„ ${c.fileName}</div>
                <div class="citation-snippet">${c.snippet}</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      const timestampHTML = timestamp ? `
        <div class="timestamp">${new Date(timestamp).toLocaleString('ja-JP')}</div>
      ` : '';

      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-text">${text}</div>
          ${citationsHTML}
          ${timestampHTML}
        </div>
      `;

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    // Enterã‚­ãƒ¼ã§é€ä¿¡
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendQuestion();
      }
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
    function showAddProjectModal() {
      document.getElementById('add-project-modal').classList.add('show');
    }

    function closeAddProjectModal() {
      document.getElementById('add-project-modal').classList.remove('show');
      document.getElementById('project-name').value = '';
      document.getElementById('project-description').value = '';
      document.getElementById('project-path').value = '';
    }

    async function addProject() {
      const name = document.getElementById('project-name').value.trim();
      const description = document.getElementById('project-description').value.trim();
      const projectPath = document.getElementById('project-path').value.trim();

      if (!name || !projectPath) {
        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨ãƒ‘ã‚¹ã¯å¿…é ˆã§ã™');
        return;
      }

      const submitBtn = document.getElementById('add-project-submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'è¿½åŠ ä¸­...';

      try {
        const response = await fetch('/api/projects', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, projectPath })
        });

        const data = await response.json();

        if (response.ok) {
          closeAddProjectModal();
          loadProjects();
          alert(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${data.project.fileCount}`);
        } else {
          alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
        }
      } catch (error) {
        console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'è¿½åŠ ';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    loadProjects();
  </script>
</body>
</html>
